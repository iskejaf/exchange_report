<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Mesa de Cambio</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        * {
            border-radius: 0% !important;
        }

        body {
            font-size: 12px;
            background: #d9d9d9;
            padding: 0;
            margin: 0;
        }

        .mainApp {
            background: #fff;
            height: calc(100vh - 50px);
            width: calc(100% - 50px);
            min-width: 960px;
            margin: 25px;
            padding: 10px 20px 5px 20px;
            /* Reducido padding-top a 10px y padding-bottom a 5px */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .top-section {
            padding-top: 0px;
            /* Reducido a 0 para que empiece más arriba */
            margin-bottom: 0px;
            /* Asegurado que no haya margen inferior */
        }

        .input-column {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100%;
        }

        /* Contenedor principal de los controles de archivo */
        .file-upload-controls {
            display: flex;
            flex-direction: column;
            margin-bottom: 5px;
            /* Espacio entre los botones y el input de búsqueda */
        }

        /* Contenedor para la fila de botones (Pactadas y No Pactadas) */
        .button-row-container {
            display: flex;
            gap: 10px;
            /* Espacio entre los grupos de botón */
            margin-bottom: 5px;
            /* Espacio entre la fila de botones y el input de búsqueda */
        }

        /* Cada grupo de botón e icono (estos son los que deben crecer por igual) */
        .button-and-status {
            display: flex;
            align-items: center;
            /* Esto ya centra verticalmente el contenido dentro de .button-and-status */
            flex-basis: 0;
            /* Empieza en ancho cero */
            flex-grow: 1;
            /* Crece para ocupar el espacio disponible equitativamente */
        }

        /* Estilos para los botones (la etiqueta 'label' que se ve como botón) */
        .file-upload-controls .btn {
            white-space: nowrap;
            padding: 0.2rem 0.75rem;
            /* Reducido el padding vertical para hacerlos menos altos */
            font-size: 0.85rem;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Esto centra el texto dentro del botón */
            flex-grow: 1;

            /* Estilos para borde azul y texto azul por defecto */
            background-color: transparent;
            color: #007bff;
            border-color: #007bff;
        }

        .file-upload-controls .btn:hover {
            /* Estilos al hacer hover (fondo azul, texto blanco) */
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
        }


        /* Aseguramos que el icono de estado sea gris por defecto */
        .file-upload-status {
            font-size: 1.2em;
            color: #ccc;
            /* Color por defecto (gris claro) */
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-left: 5px;
            /* Espacio entre el botón y el icono */
        }

        /* Cuando el archivo se carga (clase 'loaded'), el icono se vuelve negro */
        /* Usamos !important para asegurar que sobrescriba cualquier estilo de Font Awesome */
        .file-upload-status.loaded {
            color: #212529 !important;
            /* ¡MODIFICADO! Cambiado a negro, y con !important */
        }

        /* Opcional: Para el icono de "error" (sin cargar), asegúrate que sea rojo si está presente */
        .file-upload-status.fa-times-circle {
            color: #dc3545;
            /* Rojo de Bootstrap para error */
        }


        /* Estilo para el contador de Pactadas */
        .pactadas-count-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
            /* Color por defecto */
            width: 20px;
            text-align: center;
            flex-shrink: 0;
            margin-left: 5px;
            /* Espacio entre el botón y el contador */
            position: relative;
            top: -1px;
            /* Restaurado */
        }

        .pactadas-count-display.loaded {
            color: #343a40;
            /* Gris más oscuro para el contador cargado */
        }


        /* Ajuste para el input de búsqueda */
        .input-column .form-control {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            /* Reducido el padding vertical para hacerlo menos alto */
            height: auto;
        }

        .metric-box {
            background-color: #fff;
            border: none;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 5px;
            height: 100%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            text-align: left;
        }

        .metric-title {
            font-size: 0.8em;
            font-weight: bold;
            color: #555;
            margin-right: 5px;
            white-space: nowrap;
        }

        .metric-value {
            font-size: 0.9em;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        /* Ajustes para la tabla y sus contenedores */
        .col-md-9 .row.g-2:first-child {
            /* Apuntando a la primera fila de métricas */
            margin-bottom: 5px !important;
            /* Añadir un pequeño margen entre las dos filas de métricas si es necesario */
        }

        .col-md-9 .row.g-2:last-child {
            margin-bottom: 0 !important;
            /* Asegurar que la última fila de métricas no tenga margen inferior */
        }

        #excelTableContainer {
            flex-grow: 1;
            overflow: auto;
            border: none;
            /* Eliminado el borde externo del contenedor de la tabla */
            border-radius: 5px;
            padding: 0;
            margin-top: 5px;
            /* Pequeño margen superior para separar de las métricas si se desea */
            margin-bottom: 10px;
            /* Reducido para subir el footer */
        }

        #editableExcelTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            table-layout: auto;
            /* Permitir que las columnas se ajusten al contenido */
        }

        #editableExcelTable th,
        #editableExcelTable td {
            border: none;
            /* Eliminado los bordes de todas las celdas */
            padding: 8px;
            text-align: left;
            height: 25px;
        }

        /* Borde inferior para las celdas de datos */
        #editableExcelTable td {
            border-bottom: 1px solid #eee;
            /* Borde inferior más claro para las filas de datos */
        }

        /* Borde inferior y color de fondo para los encabezados */
        #editableExcelTable thead th {
            border-bottom: 1px solid #ccc;
            /* Borde inferior más delgado para los encabezados */
            background-color: white;
            /* Color de fondo blanco para los encabezados */
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: normal;
            /* Permitir que el texto del encabezado se rompa en varias líneas */
            vertical-align: middle;
            /* Centrar verticalmente el texto del encabezado que se rompe */
            text-align: center;
            /* ¡NUEVO! Centra horizontalmente el texto de los encabezados */
        }

        /* Asegurarse de que las celdas de datos normales NO rompan el texto a menos que lo desees */
        #editableExcelTable tbody td {
            white-space: nowrap;
            /* Mantener contenido de datos en una sola línea por defecto */
            overflow: hidden;
            /* Ocultar el contenido extra si no cabe */
            text-overflow: ellipsis;
            /* Añadir puntos suspensivos si se oculta */
        }

        /* Para la celda del botón de eliminar */
        #editableExcelTable td:first-child {
            padding: 5px;
            text-align: center;
            width: 30px;
            padding-left: 0;
            padding-right: 0;
            white-space: nowrap;
            display: flex;
            /* Usar flexbox para centrar el contenido */
            justify-content: center;
            /* Centrar horizontalmente */
            align-items: center;
            /* Centrar verticalmente */
            height: 100%;
            /* Asegurar que ocupe la altura completa de la fila para centrar */
        }

        /* Eliminar borde inferior de la última fila */
        #editableExcelTable tbody tr:last-child td {
            border-bottom: none;
        }


        .hidden {
            display: none !important;
        }

        /* Estilos del botón de eliminar */
        .delete-row-btn {
            background: none;
            /* Eliminar fondo */
            color: #6c757d;
            /* Color gris */
            border: none;
            padding: 0;
            /* Padding mínimo */
            border-radius: 4px;
            cursor: pointer;
            line-height: 1;
            /* Ajusta la altura de línea para centrar el icono */
            width: auto;
            height: auto;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .delete-row-btn:hover {
            color: #dc3545;
            /* Color rojo al hacer hover */
        }

        /* Estilo para el SVG dentro del botón de eliminar */
        .delete-row-btn svg {
            width: 16px;
            /* Tamaño fijo de 16px */
            height: 16px;
            /* Tamaño fijo de 16px */
            fill: currentColor;
        }


        [contenteditable="true"]:focus {
            outline: 2px solid #007bff;
        }

        #excelTableContainer::-webkit-scrollbar {
            -webkit-appearance: none;
        }

        #excelTableContainer::-webkit-scrollbar:vertical {
            width: 10px;
        }

        #excelTableContainer::-webkit-scrollbar-button:increment,
        #excelTableContainer::-webkit-scrollbar-button {
            display: none;
        }

        #excelTableContainer::-webkit-scrollbar:horizontal {
            height: 10px;
        }

        #excelTableContainer::-webkit-scrollbar-thumb {
            background-color: #797979;
            border: 2px solid #f1f2f3;
        }

        .footer-controls {
            padding-bottom: 10px;
            /* Reducido para hacer el footer más pequeño */
            padding-top: 5px;
            /* Pequeño padding superior para separación */
            text-align: right;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        .operations-count {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            margin-right: auto;
        }

        /* Estilos para el botón de Exportar a Excel */
        #exportModifiedExcel {
            padding: 0.2rem 0.75rem;
            /* Mismo padding que los botones de carga */
            font-size: 0.85rem;
            background-color: transparent;
            color: #28a745;
            /* Color verde por defecto */
            border-color: #28a745;
            /* Borde verde por defecto */
        }

        #exportModifiedExcel:hover {
            background-color: #28a745;
            /* Fondo verde al hover */
            color: #fff;
            /* Texto blanco al hover */
            border-color: #28a745;
        }
    </style>
</head>

<body>
    <div class="mainApp">
        <div class="top-section">
            <div class="row">
                <div class="col-md-3 input-column">
                    <div class="file-upload-controls">
                        <div class="button-row-container">
                            <div class="button-and-status">
                                <input type="file" id="fileInputPacto" accept=".xls,.xlsx" style="display: none;">
                                <label for="fileInputPacto" class="btn btn-primary"
                                    data-file-type="pacto">Pactadas</label>
                                <span id="filesLoadedPactoCount" class="pactadas-count-display">0</span>
                            </div>

                            <div class="button-and-status">
                                <input type="file" id="fileInputNoPactadas" accept=".xls,.xlsx" style="display: none;">
                                <label for="fileInputNoPactadas" class="btn btn-primary" data-file-type="no_pactadas">No
                                    Pactadas</label>
                                <i id="statusIconNoPactadas" class="fas fa-times-circle file-upload-status"></i>
                            </div>
                        </div>
                        <div class="form-group">
                            <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
                        </div>
                    </div>
                </div>

                <div class="col-md-9">
                    <div class="row g-2">
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Fecha Valor:</span>
                                <span class="metric-value" id="fechaValorDisplay">--/--/----</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Monto Total USD:</span>
                                <span class="metric-value" id="totalMontoUSD">0,00</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Tasa de Compra:</span>
                                <span class="metric-value" id="tasaCompraDisplay">0,0000</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Tasa Mínima:</span>
                                <span class="metric-value" id="tasaMinimaDisplay">0,0000</span>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Tipo de Cambio:</span>
                                <span class="metric-value" id="tipoCambioPromedioDisplay">0,0000</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Contravalor Bs.:</span>
                                <span class="metric-value" id="totalContravalorBsDisplay">0,00</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Tasa de Venta:</span>
                                <span class="metric-value" id="tasaVentaDisplay">0,0000</span>
                            </div>
                        </div>
                        <div class="col">
                            <div class="metric-box">
                                <span class="metric-title">Tasa Máxima:</span>
                                <span class="metric-value" id="tasaMaximaDisplay">0,0000</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="excelTableContainer" class="table-responsive hidden">
            <table id="editableExcelTable" class="table table-bordered table-hover">
            </table>
        </div>

        <div class="footer-controls hidden">
            <span class="operations-count">Cant. Operaciones: <span id="visibleRowCount">0</span></span>
            <button id="exportModifiedExcel" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar a
                Excel</button>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

    <script>
        $(document).ready(function () {
            // Referencias a los elementos del DOM para el archivo Pacto
            const fileInputPacto = $('#fileInputPacto');
            const filesLoadedPactoCount = $('#filesLoadedPactoCount'); // Nuevo elemento para el contador de Pactadas

            // Referencias a los elementos del DOM para el nuevo archivo No Pactadas
            const fileInputNoPactadas = $('#fileInputNoPactadas');
            const statusIconNoPactadas = $('#statusIconNoPactadas');


            const excelTableContainer = $('#excelTableContainer');
            const editableExcelTable = $('#editableExcelTable');
            const exportButton = $('#exportModifiedExcel');
            const searchInput = $('#searchInput');
            const footerControls = $('.footer-controls');

            // Metric display elements
            const fechaValorDisplay = $('#fechaValorDisplay');
            const totalMontoUSDSpan = $('#totalMontoUSD');
            const tasaCompraDisplay = $('#tasaCompraDisplay');
            const tasaMinimaDisplay = $('#tasaMinimaDisplay');

            const tipoCambioPromedioDisplay = $('#tipoCambioPromedioDisplay');
            const totalContravalorBsDisplay = $('#totalContravalorBsDisplay');
            const tasaVentaDisplay = $('#tasaVentaDisplay');
            const tasaMaximaDisplay = $('#tasaMaximaDisplay');

            const visibleRowCountSpan = $('#visibleRowCount');

            let workbookData = null; // Para el archivo de Pacto
            let currentTableData = null; // Para los datos mostrados en la tabla (del archivo Pacto)
            let ofertaWorkbookData = null; // Para el nuevo archivo de No Pactadas
            let pactoFilesLoadedCount = 0; // Variable para contar los archivos de Pacto cargados

            const HTML_TABLE_AND_PACTO_HEADERS = [
                "Fecha Jornada", "Fecha Pacto", "Hora Pacto", "Código Moneda Divisa",
                "Monto Divisa", "Monto USD", "Tipo de Cambio Bs./USD", "Contravalor Bs.",
                "Instrumento", "Tipo de Pacto",
                "Código Operador", "Nombre Operador", "RIF/CI", "Cliente", "Cuenta Moneda Nacional", "Cuenta Moneda Extranjera (Opcional)",
                "Código Operador", "Nombre Operador", "RIF/CI", "Cliente", "Cuenta Moneda Nacional", "Cuenta Moneda Extranjera (Opcional)"
            ];

            const NO_PACTADAS_OUTPUT_HEADERS = [
                "Fecha Jornada", "Fecha Registro", "Hora Registro", "Código Moneda Divisa",
                "Monto Divisa", "Monto USD", "Tipo de Cambio Bs./USD", "Contravalor Bs.",
                "Instrumento", "Código Operador", "Nombre Operador", "RIF/CI",
                "Cliente", "Cuenta Moneda Nacional", "Cuenta Moneda Extranjera (Opcional)"
            ];


            const fechaJornadaIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Fecha Jornada");
            const montoUSDIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Monto USD");
            const tipoCambioBsUSDIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Cambio Bs./USD");
            const contravalorBsIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Contravalor Bs.");

            // Inicializa currentTableData SOLO CON LAS CABECERAS al cargar la página
            currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
            renderTable(currentTableData); // Renderiza la tabla vacía con encabezados
            updateSummaryMetrics(); // Actualiza las métricas iniciales

            // Ocultar el footer y la tabla al inicio
            excelTableContainer.addClass('hidden');
            footerControls.addClass('hidden');


            // Función auxiliar para parsear números con formato ES
            function parseVenezuelanNumber(numStr) {
                if (numStr === null || numStr === undefined || numStr === '') {
                    return null;
                }
                if (typeof numStr === 'number') {
                    return numStr;
                }
                if (typeof numStr === 'string') {
                    const cleanedStr = numStr.replace(/\./g, '').replace(/,/g, '.');
                    const parsed = parseFloat(cleanedStr);
                    return isNaN(parsed) ? null : parsed;
                }
                return null;
            }

            // Función genérica para manejar la carga de archivos
            function handleFileUpload(fileObject, isPactoFile = true) {
                console.log("handleFileUpload se ha ejecutado.");
                const file = fileObject;
                const statusIconElem = isPactoFile ? null : statusIconNoPactadas;

                // Reset visual status for "No Pactadas"
                if (!isPactoFile) {
                    statusIconElem.removeClass('fa-check-circle loaded').addClass('fa-times-circle').css('color', '');
                } else {
                    filesLoadedPactoCount.removeClass('loaded').css('color', '');
                }


                if (!file) {
                    console.log("handleFileUpload: No se seleccionó ningún archivo o la selección fue cancelada.");
                    if (isPactoFile) {
                        if (pactoFilesLoadedCount === 0) {
                            currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
                            renderTable(currentTableData);
                            excelTableContainer.addClass('hidden');
                            footerControls.addClass('hidden');
                        }
                    } else {
                        ofertaWorkbookData = null; // Reinicia los datos de No Pactadas
                        statusIconNoPactadas.removeClass('fa-check-circle loaded').addClass('fa-times-circle');
                    }
                    updateSummaryMetrics();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    try {
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd HH:mm:ss' });

                        console.log("Workbook leído:", workbook);

                        if (isPactoFile) {
                            workbookData = workbook;
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const startingExcelRowIndex = 3;

                            if (!worksheet || !worksheet['!ref']) {
                                alert('La primera hoja del archivo Excel está vacía o no tiene un rango definido.');
                                if (pactoFilesLoadedCount === 0) {
                                    currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
                                    renderTable(currentTableData);
                                    excelTableContainer.addClass('hidden');
                                    footerControls.addClass('hidden');
                                }
                                filesLoadedPactoCount.removeClass('loaded').css('color', '').text(pactoFilesLoadedCount);
                                updateSummaryMetrics();
                                return;
                            }

                            const fullRange = XLSX.utils.decode_range(worksheet['!ref']);
                            const adjustedRange = {
                                s: { r: startingExcelRowIndex, c: fullRange.s.c },
                                e: { r: fullRange.e.r, c: fullRange.e.c }
                            };
                            const rawData = XLSX.utils.sheet_to_json(worksheet, {
                                header: 1,
                                range: adjustedRange,
                                defval: "",
                                raw: false,
                                dateNF: 'yyyy-mm-dd HH:mm:ss'
                            });

                            console.log("Raw data from Excel (starting from row 4):", rawData);

                            // Define el índice de la columna "Contravalor Bs." en tu Excel original
                            // Si la columna "Contravalor Bs." es la G, su índice es 6 (A=0, B=1, C=2, D=3, E=4, F=5, G=6)
                            // ¡AJUSTA ESTE ÍNDICE SEGÚN TU EXCEL!
                            const EXCEL_CONTRAVALOR_BS_COLUMN_INDEX = 6; // Por ejemplo, si es la columna G en tu Excel

                            const processedRawData = rawData.map(excelRow => {
                                const newExcelRow = [...excelRow]; // Copia la fila
                                // Elimina la columna de Contravalor Bs. si existe
                                if (EXCEL_CONTRAVALOR_BS_COLUMN_INDEX >= 0 && EXCEL_CONTRAVALOR_BS_COLUMN_INDEX < newExcelRow.length) {
                                    newExcelRow.splice(EXCEL_CONTRAVALOR_BS_COLUMN_INDEX, 1);
                                }
                                return newExcelRow;
                            });

                            if (processedRawData.length > 0) {
                                const today = new Date();
                                const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

                                // Definimos los índices de las columnas TAL COMO ESPERAMOS QUE ESTÉN EN processedRawData
                                // Después de haber eliminado la columna de Contravalor Bs.
                                // ¡ADECÚA ESTOS ÍNDICES SI TU EXCEL TIENE OTRO ORDEN O MÁS/MENOS COLUMNAS!
                                const PROCESSED_EXCEL_COLUMN_MAP = {
                                    "Fecha Pacto": 0,
                                    "Hora Pacto": 1,
                                    "Código Moneda Divisa": 2,
                                    "Monto Divisa": 3,
                                    "Monto USD": 4,
                                    "Tipo de Cambio Bs./USD": 5,
                                    "Instrumento": 6, // Este es el índice después de eliminar Contravalor Bs.
                                    "Tipo de Pacto": 7,
                                    "Código Operador Oferta": 8,
                                    "Nombre Operador Oferta": 9,
                                    "RIF/CI Oferta": 10,
                                    "Cliente Oferta": 11,
                                    "Cuenta Moneda Nacional Oferta": 12,
                                    "Cuenta Moneda Extranjera (Opcional) Oferta": 13,
                                    "Código Operador Demanda": 14,
                                    "Nombre Operador Demanda": 15,
                                    "RIF/CI Demanda": 16,
                                    "Cliente Demanda": 17,
                                    "Cuenta Moneda Nacional Demanda": 18,
                                    "Cuenta Moneda Extranjera (Opcional) Demanda": 19
                                };


                                processedRawData.forEach(excelRowFiltered => {
                                    if (excelRowFiltered && excelRowFiltered.length > 0 && excelRowFiltered.some(cell => cell !== null && String(cell).trim() !== '')) {
                                        const newRow = new Array(HTML_TABLE_AND_PACTO_HEADERS.length).fill(null);
                                        newRow[fechaJornadaIndex] = todayFormatted;

                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Fecha Pacto")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Fecha Pacto"]] ? new Date(excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Fecha Pacto"]]).toISOString().split('T')[0] : '';
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Hora Pacto")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Hora Pacto"]] ? String(excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Hora Pacto"]]) : '';
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Código Moneda Divisa")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Código Moneda Divisa"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Monto Divisa")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Monto Divisa"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Monto USD")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Monto USD"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Cambio Bs./USD")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Tipo de Cambio Bs./USD"]];
                                        // Contravalor Bs. no se lee del Excel, se calcula más abajo

                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Instrumento")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Instrumento"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Pacto")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Tipo de Pacto"]];

                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Código Operador")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Código Operador Oferta"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Nombre Operador")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Nombre Operador Oferta"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("RIF/CI")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["RIF/CI Oferta"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cliente")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cliente Oferta"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Nacional")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cuenta Moneda Nacional Oferta"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)")] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cuenta Moneda Extranjera (Opcional) Oferta"]];

                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Código Operador", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Código Operador Demanda"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Nombre Operador", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Nombre Operador Demanda"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("RIF/CI", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["RIF/CI Demanda"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cliente", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cliente Demanda"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Nacional", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cuenta Moneda Nacional Demanda"]];
                                        newRow[HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)", HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)") + 1)] = excelRowFiltered[PROCESSED_EXCEL_COLUMN_MAP["Cuenta Moneda Extranjera (Opcional) Demanda"]];


                                        const montoUSD = parseVenezuelanNumber(newRow[montoUSDIndex]);
                                        const tipoCambio = parseVenezuelanNumber(newRow[tipoCambioBsUSDIndex]);

                                        let contravalorCalculado = null;
                                        if (montoUSD !== null && tipoCambio !== null) {
                                            contravalorCalculado = parseFloat((montoUSD * tipoCambio).toFixed(2));
                                        }
                                        newRow[contravalorBsIndex] = contravalorCalculado;
                                        currentTableData.push(newRow);
                                    } else {
                                        console.log("Fila vacía o inválida omitida:", excelRowFiltered);
                                    }
                                });
                                console.log("currentTableData after processing:", currentTableData);

                                renderTable(currentTableData);
                                excelTableContainer.removeClass('hidden');
                                footerControls.removeClass('hidden');
                                pactoFilesLoadedCount++;
                                filesLoadedPactoCount.text(pactoFilesLoadedCount).addClass('loaded');
                            } else {
                                alert('El archivo de Pacto está vacío o no tiene datos válidos a partir de la fila 4.');
                                if (pactoFilesLoadedCount === 0) {
                                    excelTableContainer.addClass('hidden');
                                    footerControls.addClass('hidden');
                                }
                                filesLoadedPactoCount.removeClass('loaded').css('color', '').text(pactoFilesLoadedCount);
                            }
                        } else { // Esto es para el archivo de "No Pactadas"
                            ofertaWorkbookData = workbook;
                            statusIconNoPactadas.removeClass('fa-times-circle').addClass('fa-check-circle loaded');
                            console.log("Archivo de No Pactadas cargado exitosamente. No se procesa para la tabla HTML por ahora.");
                        }
                    } catch (error) {
                        console.error("Error al procesar el archivo Excel:", error);
                        alert("Hubo un error al procesar el archivo Excel. Asegúrate de que el formato sea correcto.");
                        if (isPactoFile && pactoFilesLoadedCount === 0) {
                            currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
                            renderTable(currentTableData);
                            excelTableContainer.addClass('hidden');
                            footerControls.addClass('hidden');
                        }
                        if (!isPactoFile) {
                            statusIconNoPactadas.removeClass('fa-check-circle loaded').addClass('fa-times-circle').css('color', '');
                        } else {
                            filesLoadedPactoCount.removeClass('loaded').css('color', '').text(pactoFilesLoadedCount);
                        }
                        if (isPactoFile) {
                            fileInputPacto.val('');
                        } else {
                            fileInputNoPactadas.val('');
                        }
                    }
                    searchInput.val('');
                    filterTable();
                    updateSummaryMetrics();

                    if (isPactoFile) {
                        fileInputPacto.val('');
                    } else {
                        fileInputNoPactadas.val('');
                    }
                };
                reader.onerror = function (e) {
                    console.error("Error al leer el archivo con FileReader:", e);
                    alert("No se pudo leer el archivo. Inténtalo de nuevo.");
                    if (!isPactoFile) {
                        statusIconNoPactadas.removeClass('fa-check-circle loaded').addClass('fa-times-circle').css('color', '');
                    } else {
                        filesLoadedPactoCount.removeClass('loaded').css('color', '').text(pactoFilesLoadedCount);
                    }
                    if (isPactoFile && pactoFilesLoadedCount === 0) {
                        currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
                        renderTable(currentTableData);
                        excelTableContainer.addClass('hidden');
                        footerControls.addClass('hidden');
                    }
                    if (isPactoFile) {
                        fileInputPacto.val('');
                    } else {
                        fileInputNoPactadas.val('');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            fileInputPacto.on('change', function (e) {
                console.log("Evento change de fileInputPacto disparado.");
                const selectedFile = e.target.files ? e.target.files[0] : null;

                if (selectedFile) {
                    handleFileUpload(selectedFile, true);
                } else {
                    console.log("No file selected for Pacto.");
                    // Si no se selecciona archivo, y no hay datos previos, resetear la tabla
                    if (pactoFilesLoadedCount === 0) {
                        currentTableData = [HTML_TABLE_AND_PACTO_HEADERS];
                        renderTable(currentTableData);
                        excelTableContainer.addClass('hidden');
                        footerControls.addClass('hidden');
                    }
                    updateSummaryMetrics();
                }
            });

            fileInputNoPactadas.on('change', function (e) {
                console.log("Evento change de fileInputNoPactadas disparado.");
                const selectedFile = e.target.files ? e.target.files[0] : null;

                if (selectedFile) {
                    handleFileUpload(selectedFile, false);
                } else {
                    console.log("No file selected for No Pactadas.");
                    statusIconNoPactadas.removeClass('fa-check-circle loaded').addClass('fa-times-circle');
                    ofertaWorkbookData = null;
                }
            });

            function renderTable(data) {
                let tableHtml = '<thead><tr>';
                tableHtml += '<th></th>'; // Columna para el botón de eliminar

                data[0].forEach(header => {
                    tableHtml += `<th>${header !== undefined ? header : ''}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';

                for (let i = 1; i < data.length; i++) {
                    tableHtml += '<tr>';
                    // Aquí se inserta el SVG directamente en el botón
                    tableHtml += `<td><button class="delete-row-btn" data-row-index="${i - 1}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></td>`;
                    data[i].forEach((cellData, colIndex) => {
                        let displayData = cellData !== undefined && cellData !== null ? cellData : '';

                        let formattedValue = displayData;
                        let numericValue = parseVenezuelanNumber(displayData);

                        if (numericValue !== null && typeof numericValue === 'number') {
                            switch (colIndex) {
                                case 4: // Monto Divisa
                                case 5: // Monto USD
                                case 7: // Contravalor Bs. (que será nuestro calculado)
                                    formattedValue = numericValue.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                    break;
                                case 6: // Tipo de Cambio Bs./USD
                                    formattedValue = numericValue.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                                    break;
                                default:
                                    formattedValue = displayData;
                            }
                        } else {
                            formattedValue = displayData === null ? '' : String(displayData);
                        }

                        // Contravalor Bs. (índice 7) y Fecha Jornada (índice 0) NO deben ser editables
                        const isEditable = (colIndex !== fechaJornadaIndex && colIndex !== contravalorBsIndex) ? 'contenteditable="true"' : '';
                        tableHtml += `<td ${isEditable}>${formattedValue}</td>`;
                    });
                    tableHtml += '</tr>';
                }
                tableHtml += '</tbody>';
                editableExcelTable.html(tableHtml);
            }

            function filterTable() {
                const searchTerm = searchInput.val().toLowerCase().trim();
                const rows = editableExcelTable.find('tbody tr');
                let anyRowVisible = false;

                rows.each(function () {
                    const rowText = $(this).text().toLowerCase();
                    if (searchTerm === '' || rowText.includes(searchTerm)) {
                        $(this).show();
                        anyRowVisible = true;
                    } else {
                        $(this).hide();
                    }
                });

                if (!anyRowVisible && searchTerm !== '') {
                    excelTableContainer.addClass('hidden');
                    footerControls.addClass('hidden');
                } else if (anyRowVisible && !excelTableContainer.is(':visible')) {
                    excelTableContainer.removeClass('hidden');
                    footerControls.removeClass('hidden');
                }

                updateSummaryMetrics();
            }

            function updateSummaryMetrics() {
                // Reinicializar todas las sumas y contadores
                let totalMontoUSD = 0; // Este ahora será el filtrado por tipo de pacto
                let totalContravalorBs = 0; // Este ahora será el filtrado por tipo de pacto
                let visibleRowsCount = 0;
                let fechaValor = '--/--/----';

                let tasaMinima = Infinity;
                let tasaMaxima = -Infinity;

                let sumContravalorBsCompra = 0;
                let sumMontoUSDCompra = 0;

                let sumContravalorBsVenta = 0;
                let sumMontoUSDVenta = 0;

                // Índices de las columnas relevantes
                const tipoPactoIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Pacto");
                const clienteOfertaIndex = HTML_TABLE_AND_PACTO_HEADERS.indexOf("Cliente"); // Primer "Cliente"
                const clienteDemandaIndex = HTML_TABLE_AND_PACTO_HEADERS.lastIndexOf("Cliente"); // Último "Cliente"

                const excludePactoTypes = ["CANJEE", "CANJET", "CANJE$", "CANJE€"];
                const excludeClientName = "BANCO NACIONAL DE CREDITO";

                editableExcelTable.find('tbody tr').each(function () {
                    if ($(this).is(':visible')) {
                        visibleRowsCount++;
                        const rowIndexInCurrentTableData = $(this).index() + 1; // +1 porque currentTableData incluye cabeceras
                        const rowDataInTable = currentTableData[rowIndexInCurrentTableData];

                        if (visibleRowsCount === 1) {
                            fechaValor = rowDataInTable[fechaJornadaIndex] || '--/--/----';
                        }

                        const montoUSD = parseVenezuelanNumber(rowDataInTable[montoUSDIndex]);
                        const tipoCambio = parseVenezuelanNumber(rowDataInTable[tipoCambioBsUSDIndex]);
                        const contravalorBs = parseVenezuelanNumber(rowDataInTable[contravalorBsIndex]);
                        const tipoPacto = rowDataInTable[tipoPactoIndex];
                        const clienteOferta = rowDataInTable[clienteOfertaIndex];
                        const clienteDemanda = rowDataInTable[clienteDemandaIndex];

                        // Lógica para Tasa Mínima y Tasa Máxima (se mantiene sobre todos los visibles)
                        if (tipoCambio !== null) {
                            if (tipoCambio < tasaMinima) {
                                tasaMinima = tipoCambio;
                            }
                            if (tipoCambio > tasaMaxima) {
                                tasaMaxima = tipoCambio;
                            }
                        }

                        // Lógica para Monto Total USD y Contravalor Bs. (ahora filtrado por tipo de pacto)
                        const isNotExcludedPactoType = !excludePactoTypes.includes(tipoPacto);
                        if (isNotExcludedPactoType) {
                            if (montoUSD !== null) {
                                totalMontoUSD += montoUSD;
                            }
                            if (contravalorBs !== null) {
                                totalContravalorBs += contravalorBs;
                            }
                        }

                        // Lógica para Tasa de Compra (se mantiene)
                        const isForCompra = (clienteOferta !== excludeClientName && isNotExcludedPactoType);
                        if (isForCompra && contravalorBs !== null && montoUSD !== null) {
                            sumContravalorBsCompra += contravalorBs;
                            sumMontoUSDCompra += montoUSD;
                        }

                        // Lógica para Tasa de Venta (se mantiene)
                        const isForVenta = (clienteDemanda !== excludeClientName && isNotExcludedPactoType);
                        if (isForVenta && contravalorBs !== null && montoUSD !== null) {
                            sumContravalorBsVenta += contravalorBs;
                            sumMontoUSDVenta += montoUSD;
                        }
                    }
                });

                fechaValorDisplay.text(fechaValor);
                // Monto Total USD y Contravalor Bs. ya están filtrados
                totalMontoUSDSpan.text(totalMontoUSD.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

                // Calcular y mostrar Tasa de Compra
                let tasaCompraCalculated = 0;
                if (sumMontoUSDCompra > 0) {
                    tasaCompraCalculated = sumContravalorBsCompra / sumMontoUSDCompra;
                }
                tasaCompraDisplay.text(tasaCompraCalculated.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));

                if (tasaMinima === Infinity) {
                    tasaMinimaDisplay.text('0,0000');
                } else {
                    tasaMinimaDisplay.text(tasaMinima.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));
                }

                // Calcular y mostrar Tipo de Cambio Promedio (ahora basado en los totales filtrados)
                let tipoCambioPromedioCalculated = 0;
                if (totalMontoUSD > 0) {
                    tipoCambioPromedioCalculated = totalContravalorBs / totalMontoUSD;
                }
                tipoCambioPromedioDisplay.text(tipoCambioPromedioCalculated.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));

                // Contravalor Bs. ya está filtrado
                totalContravalorBsDisplay.text(totalContravalorBs.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

                // Calcular y mostrar Tasa de Venta
                let tasaVentaCalculated = 0;
                if (sumMontoUSDVenta > 0) {
                    tasaVentaCalculated = sumContravalorBsVenta / sumMontoUSDVenta;
                }
                tasaVentaDisplay.text(tasaVentaCalculated.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));

                if (tasaMaxima === -Infinity) {
                    tasaMaximaDisplay.text('0,0000');
                } else {
                    tasaMaximaDisplay.text(tasaMaxima.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));
                }

                visibleRowCountSpan.text(visibleRowsCount);

                if (visibleRowsCount > 0 && currentTableData.length > 1) {
                    excelTableContainer.removeClass('hidden');
                    footerControls.removeClass('hidden');
                } else {
                    excelTableContainer.addClass('hidden');
                    footerControls.addClass('hidden');
                }
            }

            searchInput.on('keyup', filterTable);

            editableExcelTable.on('click', '.delete-row-btn', function () {
                const tr = $(this).closest('tr');
                const rowIndexInHtml = tr.index();
                currentTableData.splice(rowIndexInHtml + 1, 1);
                tr.remove();
                updateSummaryMetrics();

                if (currentTableData.length <= 1) {
                    excelTableContainer.addClass('hidden');
                    footerControls.addClass('hidden');
                }
            });

            $(document).on('blur', 'td[contenteditable="true"]', function () {
                const cell = $(this);
                const colIndex = cell.index() - 1; // -1 porque la primera columna es el botón de eliminar
                const row = cell.closest('tr');
                const rowIndex = row.index() + 1; // +1 porque currentTableData incluye las cabeceras en el índice 0

                let oldValue = currentTableData[rowIndex][colIndex];
                let newValueRaw = cell.text();

                let newValue = null;

                // Definimos los índices de las columnas que requieren un formato numérico
                const numFormatCols = [
                    HTML_TABLE_AND_PACTO_HEADERS.indexOf("Monto Divisa"),
                    HTML_TABLE_AND_PACTO_HEADERS.indexOf("Monto USD"),
                    HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Cambio Bs./USD"),
                    // HTML_TABLE_AND_PACTO_HEADERS.indexOf("Contravalor Bs.") no se incluye aquí porque es solo de salida
                ];

                if (numFormatCols.includes(colIndex)) {
                    newValue = parseVenezuelanNumber(newValueRaw);
                    if (newValue !== null) {
                        // Aplicar formato de visualización a la celda
                        if (colIndex === HTML_TABLE_AND_PACTO_HEADERS.indexOf("Tipo de Cambio Bs./USD")) {
                            cell.text(newValue.toLocaleString('es-VE', { minimumFractionDigits: 4, maximumFractionDigits: 4 }));
                        } else {
                            cell.text(newValue.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                        }
                    } else {
                        cell.text(''); // Limpiar si no es un número válido
                    }
                } else if (colIndex === HTML_TABLE_AND_PACTO_HEADERS.indexOf("Fecha Pacto")) {
                    if (newValueRaw.trim() === '') {
                        newValue = '';
                    } else if (!/^\d{4}-\d{2}-\d{2}$/.test(newValueRaw)) {
                        alert('Formato de fecha incorrecto. Use YYYY-MM-DD.');
                        newValue = oldValue; // Revertir al valor anterior
                        cell.text(oldValue === null ? '' : String(oldValue));
                    } else {
                        newValue = newValueRaw;
                    }
                }
                else if (colIndex === HTML_TABLE_AND_PACTO_HEADERS.indexOf("Hora Pacto")) {
                    newValue = newValueRaw.trim(); // Simplemente toma el texto tal cual
                }
                else {
                    newValue = newValueRaw.trim(); // Para texto general
                }

                if (currentTableData[rowIndex][colIndex] !== newValue) {
                    currentTableData[rowIndex][colIndex] = newValue;

                    // Recalcular Contravalor Bs. si se modifica Monto USD o Tipo de Cambio
                    if (colIndex === montoUSDIndex || colIndex === tipoCambioBsUSDIndex) {
                        const montoUSD = parseVenezuelanNumber(currentTableData[rowIndex][montoUSDIndex]);
                        const tipoCambio = parseVenezuelanNumber(currentTableData[rowIndex][tipoCambioBsUSDIndex]);

                        let contravalorCalculado = null;
                        if (montoUSD !== null && tipoCambio !== null) {
                            contravalorCalculado = parseFloat((montoUSD * tipoCambio).toFixed(2));
                        }
                        currentTableData[rowIndex][contravalorBsIndex] = contravalorCalculado;

                        const contravalorCell = row.find('td').eq(contravalorBsIndex + 1); // +1 por la columna del botón
                        if (contravalorCalculado !== null) {
                            contravalorCell.text(contravalorCalculado.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                        } else {
                            contravalorCell.text('');
                        }
                    }
                    updateSummaryMetrics();
                }
            });

            $('#exportModifiedExcel').on('click', function () {
                const fileName = "reporte_mesa_de_cambio.xlsx";

                const wb = XLSX.utils.book_new();

                // ----------------------------------------------------
                // HOJA: Pacto
                // ----------------------------------------------------
                const pactoHeadersRow2 = HTML_TABLE_AND_PACTO_HEADERS;
                const pactoData = [];

                const pactoHeadersRow1 = [];
                pactoHeadersRow1[0] = { v: "Datos del Pacto", s: { font: { sz: 10, bold: true, color: { rgb: "FFFFFFFF" } }, alignment: { horizontal: 'center' }, fill: { fgColor: { rgb: "FF16365C" } }, border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } } };
                pactoHeadersRow1[10] = { v: "Datos de la Oferta", s: { font: { sz: 10, bold: true, color: { rgb: "FFFFFFFF" } }, alignment: { horizontal: 'center' }, fill: { fgColor: { rgb: "FF366092" } }, border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } } };
                pactoHeadersRow1[17] = { v: "Datos de la Demanda", s: { font: { sz: 10, bold: true, color: { rgb: "FFFFFFFF" } }, alignment: { horizontal: 'center' }, fill: { fgColor: { rgb: "FF538DD5" } }, border: { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } } } };
                pactoData.push(pactoHeadersRow1);
                pactoData.push(pactoHeadersRow2);

                for (let i = 1; i < currentTableData.length; i++) {
                    const row = currentTableData[i];
                    const rowData = [];

                    row.forEach((cellValue, colIndex) => {
                        const colHeader = HTML_TABLE_AND_PACTO_HEADERS[colIndex];

                        let exportValue = cellValue;
                        let cellType = 's';
                        let cellFormat = '@';

                        if (colIndex === 4 || colIndex === 5 || colIndex === 6 || colIndex === 7) {
                            let parsedValue = parseVenezuelanNumber(cellValue);
                            if (parsedValue !== null) {
                                exportValue = parsedValue;
                                cellType = 'n';
                                if (colIndex === 6) { // Tipo de Cambio Bs./USD
                                    cellFormat = '0.0000';
                                } else if (colIndex === 7) { // Contravalor Bs.
                                    exportValue = parseFloat(parsedValue.toFixed(2));
                                    cellFormat = '#,##0.00';
                                } else { // Monto Divisa, Monto USD
                                    cellFormat = '#,##0.00';
                                }
                            } else {
                                exportValue = '';
                            }
                        }
                        else if (colHeader === "Fecha Jornada" || colHeader === "Fecha Pacto") {
                            if (typeof cellValue === 'string' && cellValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                exportValue = cellValue;
                                cellType = 's';
                            } else {
                                exportValue = '';
                                cellType = 's';
                            }
                        }
                        else if (colHeader === "Hora Pacto") {
                            exportValue = String(cellValue || ''); // Exporta la hora como string
                            cellType = 's'; // Tipo de celda: string
                            cellFormat = '@'; // Formato de texto general
                        }
                        else if (colHeader.includes("RIF/CI") || colHeader.includes("Cuenta Moneda Nacional") || colHeader.includes("Cuenta Moneda Extranjera")) {
                            exportValue = String(cellValue || '');
                            cellType = 's';
                            cellFormat = '@';
                        } else {
                            exportValue = String(cellValue || '');
                            cellType = 's';
                            cellFormat = '@';
                        }
                        rowData.push({ v: exportValue, t: cellType, z: cellFormat });
                    });
                    pactoData.push(rowData);
                }

                const wsPacto = XLSX.utils.aoa_to_sheet(pactoData);

                wsPacto['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 9 } },
                    { s: { r: 0, c: 10 }, e: { r: 0, c: 16 } },
                    { s: { r: 0, c: 17 }, e: { r: 0, c: 21 } }
                ];

                const borderThin = {
                    top: { style: "thin", color: { auto: 1 } },
                    bottom: { style: "thin", color: { auto: 1 } },
                    left: { style: "thin", color: { auto: 1 } },
                    right: { style: "thin", color: { auto: 1 } }
                };

                const styleHeaderRow2 = {
                    font: { sz: 10 },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                    border: borderThin,
                    fill: { fgColor: { rgb: "FFD9D9D9" } }
                };

                const styleDataText = { font: { sz: 11 }, alignment: { vertical: "center" } };
                const styleDataNumber = { font: { sz: 11 }, alignment: { horizontal: "right", vertical: "center" } };

                const range = XLSX.utils.decode_range(wsPacto['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!wsPacto[cellRef]) wsPacto[cellRef] = {};

                        if (R === 0) {
                            // Estilo ya aplicado en la creación de pactoHeadersRow1
                        } else if (R === 1) {
                            wsPacto[cellRef].s = styleHeaderRow2;
                        } else {
                            let currentCell = wsPacto[cellRef];
                            if (currentCell.t === 'n') {
                                currentCell.s = { ...styleDataNumber, numFmt: currentCell.z };
                            } else {
                                currentCell.s = { ...styleDataText, numFmt: currentCell.z };
                            }
                            currentCell.s.border = borderThin; // Aplicar borde a todas las celdas de datos
                        }
                    }
                }

                // Ajuste para que '!cols' tenga la longitud correcta (22 elementos para 22 columnas)
                wsPacto['!cols'] = [
                    { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 18 }, { wch: 18 }, { wch: 12 }, { wch: 15 }, // 0-9
                    { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 30 }, { wch: 25 }, { wch: 30 }, // 10-15
                    { wch: 15 }, { wch: 30 }, { wch: 15 }, { wch: 30 }, { wch: 25 }, { wch: 30 }  // 16-21 (total 22 columnas)
                ];
                XLSX.utils.book_append_sheet(wb, wsPacto, "Pacto");


                // ----------------------------------------------------
                // HOJA: Descripción
                // ----------------------------------------------------
                const descripcionContent = [
                    ["Descripción"],
                    ["Día hábil en el que se notifica al BCV las operaciones de compra y venta de moneda extranjera, el cual debe tener el formatoYYYY-MM-DD (Ejemplo: 2021-11-23)"],
                    ["Día hábil en el que se efectuó el pacto, el cual debe tener el formatoYYYY-MM-DD (Ejemplo: 2019-05-10)"],
                    ["Hora del día hábil en el que se efectuó el pacto, la cual debe tener el formato 24 horas HH:MM:SS (Ejemplo: 15:30:15)"],
                    ["Código ISO de la moneda de la transacción. (Ejemplo: 840 USD / 978 EUR)."],
                    ["Monto del pacto en Divisa, entero con 2 decimales."],
                    ["Monto del pacto en USD, entero con 2 decimales."],
                    ["Tipo de cambio Bs./USD correspondiente al pacto, entero con 4 decimales."],
                    ["Contravalor en Bolívares, entero con 2 decimales."],
                    ["Instrumento financiero mediante el cual se realiza la operación (EF: Efectivo, TR:Transferencia, CH:Cheque)."],
                    ["Código alfabético que describe el tipo de pacto:"],
                    ["OCACLI: Operación de venta por parte de un operador cambiario (OCA) a un cliente."],
                    ["CLIOCA: Operación de compra por parte de un OCA a un cliente."],
                    ["CPEOCA: Operación de venta de un cliente a un operador cambiario, cuyo origen de las divisas provienen de sus saldos mantenidos en cuentas en monedas extranjeras abiertas en el Sistema Financiero Nacional, y vendidas a través de las Mesas de Cambio, utilizando canales y nuevos productos autorizados por la SUDEBAN."],
                    ["OCACPE: Operación de venta de un operador cambiario a un cliente a través de las Mesas de Cambio, utilizando canales y nuevos productos autorizados por la SUDEBAN."],
                    ["EBMCLI: Operación de venta de un operador cambiario, cuyo origen de las divisas proviene de la desacumulación de divisas Sistema de Bajo Valor (Menudeo) a un cliente."],
                    ["PPOCLI: Operación de venta de un operador cambiario a un cliente, cuyo origen de las divisas proviene de la posición propia de la Institución Financiera."],
                    ["OPCCLI: Operación de venta de un operador cambiario a un cliente, cuyo origen de las divisas proviene de una porción (hasta un máximo equivalente al diez por ciento (10%)) de la captación de fondos en moneda extranjera, de la Institución Financiera."],
                    ["IGTCLI: Operación de venta de un operador cambiario a un cliente, cuyo origen de las divisas proviene del cobro del impuesto a las grandes transacciones financieras."],
                    ["MCLCLI: Operación de venta de un operador cambiario a un cliente, cuyo origen de las divisas proviene del Sistema de Bajo Valor producto de la comercialización de combustible líquido."],
                    ["CCLOCA: Operación de venta de un cliente Casa de Cambio, cuyo origen de las divisas proviene de la comercialización de combustible líquido."],
                    ["CCMOCA: Operación de venta de un cliente Casa de Cambio, cuyo origen de las divisas proviene del Sistema de Bajo Valor (Menudeo) a un OCA."],
                    ["OCMCLI: Operación de venta de un operador cambiario, cuyo origen de las divisas proviene del Sistema de Bajo Valor (Menudeo) a un cliente."],
                    ["ECMOCA: Operación de venta de un cliente Casa de Cambio, cuyo origen de las divisas proviene de la desacumulación de divisas del Sistema de Bajo Valor (Menudeo) a un OCA."],
                    ["CLICLI: Cruce directo entre clientes."],
                    ["OCAOCA: Operación Interbancaria."],
                    ["FIDOCA: Operación de venta por parte de un cliente (Fideicomiso) a un OCA."],
                    ["FIDCLI: Operación de venta por parte de un cliente (Fideicomiso) a un cliente."],
                    ["CANJEE: Operación de canje de divisas a través de su mesa de cambio, con la misma moneda con instrumento Efectivo por Instrumento Transferencia, donde el cliente oferente y el cliente demandante es la misma persona."],
                    ["CANJET: Operación de canje de divisas a través de su mesa de cambio con el mismo instrumento, con moneda Transferencia por Instrumento Efectivo, donde el cliente oferente y el cliente demandante es la misma persona."],
                    ["CANJE$: Operación de canje de divisas a través de su mesa de cambio con el mismo instrumento, con moneda Dólar por moneda Euro, donde el cliente oferente y el cliente demandante es la misma persona."],
                    ["CANJE€: Operación de canje de divisas a través de su mesa de cambio con el mismo instrumento, con moneda Euro por moneda Dólar, donde el cliente oferente y el cliente demandante es la misma persona."],
                    ["CHECLI: Operación de venta de un operador cambiario a un cliente, cuyo origen de las divisas proviene de las ventas efectuadas por Chevron Global Technology Services Company."],
                    ["Código asignado por la SUDEBAN que consta de 3 caracteres de longitud."],
                    ["Nombre del operador cambiario."],
                    ["Registro de Información Fiscal (RIF), Cédula de Identidad (V,E) o Pasaporte (P), que identifique el cliente, con el siguiente formato: para el caso de los códigos de identificación \"J\" admitiendo un máximo 9 digitos; y para los clientes con \"V\" o \"E\", admitiendo un máximo de 8 dígitos; y ara el caso de pasaportes, comenzando con el código de identificación \"P\" sin limitación alfanumérica. Ejemplo: J123456789; V12345678; E12345678; P123789456789456789. Completar con ceros a la izquierda luego del caracter alfabético y no colocar puntos ni guiones o caracteres especiales."],
                    ["Nombre o razón social del cliente oferente."],
                    ["Código numérico de 20 dígitos de la cuenta en moneda nacional que mantiene el cliente oferente en la Institución Financiera."],
                    ["Código numérico de la cuenta en moneda extranjera del cliente oferente."]
                ];

                const wsDescripcion = XLSX.utils.aoa_to_sheet(descripcionContent);

                const borderAllThin = {
                    top: { style: "thin", color: { auto: 1 } },
                    bottom: { style: "thin", color: { auto: 1 } },
                    left: { style: "thin", color: { auto: 1 } },
                    right: { style: "thin", color: { auto: 1 } }
                };

                const rangeDesc = XLSX.utils.decode_range(wsDescripcion['!ref']);

                for (let R = rangeDesc.s.r; R <= rangeDesc.e.r; ++R) {
                    for (let C = rangeDesc.s.c; C <= rangeDesc.s.c; ++C) {
                        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!wsDescripcion[cellRef]) wsDescripcion[cellRef] = { v: undefined, t: 's' };

                        let currentCellStyle = {
                            font: { sz: 11 },
                            alignment: { vertical: "top", wrapText: false },
                            border: {
                                top: { style: "none" }, bottom: { style: "none" },
                                left: { style: "none" }, right: { style: "none" }
                            }
                        };

                        if (R === 0 || R === 10) {
                            currentCellStyle.font.bold = true;
                        }

                        if (R === 0) {
                            currentCellStyle.alignment.horizontal = "center";
                        }

                        if (C === 0) {
                            if (R === 0 || R === 10) {
                                currentCellStyle.border = borderAllThin;
                            } else {
                                currentCellStyle.border.left = borderAllThin.left;
                                currentCellStyle.border.right = borderAllThin.right;
                                if (R === rangeDesc.s.r + 1) {
                                    currentCellStyle.border.top = borderAllThin.top;
                                }
                                if (R === rangeDesc.e.r) {
                                    currentCellStyle.border.bottom = borderAllThin.bottom;
                                }
                            }
                        }

                        wsDescripcion[cellRef].s = currentCellStyle;
                    }
                }

                wsDescripcion['!cols'] = [{ wch: 200 }];

                wsDescripcion['!sheet'] = {
                    'SheetPr': {
                        'TabColor': { 'rgb': "FF808080" }
                    }
                };
                XLSX.utils.book_append_sheet(wb, wsDescripcion, "Descripción");


                // ----------------------------------------------------
                // HOJA: Oferta (No pactada)
                // ----------------------------------------------------
                const ofertaNoPactadaRawData = [];
                let hasOfertaData = false;

                // Añadir títulos y encabezados como arrays simples para aoa_to_sheet
                const ofertaTitleRow_simple = [];
                ofertaTitleRow_simple[0] = "Oferta (No Pactada)";
                ofertaNoPactadaRawData.push(ofertaTitleRow_simple);
                ofertaNoPactadaRawData.push(NO_PACTADAS_OUTPUT_HEADERS); // Solo los nombres de los encabezados

                // Procesar datos de ofertaWorkbookData si está cargado
                if (ofertaWorkbookData) {
                    const firstSheetNameNoPactadas = ofertaWorkbookData.SheetNames[0];
                    const worksheetNoPactadas = ofertaWorkbookData.Sheets[firstSheetNameNoPactadas];

                    if (worksheetNoPactadas && worksheetNoPactadas['!ref']) {
                        const rawNoPactadasData = XLSX.utils.sheet_to_json(worksheetNoPactadas, {
                            header: 1, // Obtener como array de arrays
                            range: 1,  // Empezar a leer desde la fila 2 (índice 1 en 0-based)
                            defval: "",
                            raw: false,
                            dateNF: 'yyyy-mm-dd HH:mm:ss'
                        });

                        const inputHeadersNoPactadas = XLSX.utils.sheet_to_json(worksheetNoPactadas, { header: 1, range: 0, defval: "", raw: false })[0];
                        const inputHeaderMap = {};
                        inputHeadersNoPactadas.forEach((header, index) => {
                            inputHeaderMap[header] = index;
                        });

                        const today = new Date();
                        const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

                        rawNoPactadasData.forEach(row => {
                            const operationType = String(row[inputHeaderMap["OperationType"]] || '').trim(); // Asegurarse que es string y trim

                            if (operationType === "OFERTA") {
                                hasOfertaData = true;
                                const newRow = new Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill(null);

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Jornada")] = todayFormatted;
                                const pactDate = String(row[inputHeaderMap["PactDate"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Registro")] = pactDate.substring(0, 10);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Hora Registro")] = pactDate.substring(11, 19);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Código Moneda Divisa")] = String(row[inputHeaderMap["CurrencyCode"]] || '');

                                let montoDivisa = parseVenezuelanNumber(row[inputHeaderMap["CurrencyAmount"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa")] = montoDivisa !== null ? montoDivisa : '';

                                let montoUSD = parseVenezuelanNumber(row[inputHeaderMap["CurrencyBaseAmount"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD")] = montoUSD !== null ? montoUSD : '';

                                let tipoCambio = parseVenezuelanNumber(row[inputHeaderMap["PriceVES_Currency"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")] = tipoCambio !== null ? tipoCambio : '';

                                let contravalorBs = null;
                                if (montoUSD !== null && tipoCambio !== null) {
                                    contravalorBs = parseFloat((montoUSD * tipoCambio).toFixed(2));
                                }
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")] = contravalorBs !== null ? contravalorBs : '';

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Instrumento")] = String(row[inputHeaderMap["InstrumentType"]] || '');

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Código Operador")] = String(row[inputHeaderMap["Offer_OperatorCode"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Nombre Operador")] = String(row[inputHeaderMap["Offer_OperatorName"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("RIF/CI")] = String(row[inputHeaderMap["Offer_CustomerIdentification"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cliente")] = String(row[inputHeaderMap["Offer_ClientName"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Nacional")] = String(row[inputHeaderMap["Offer_Account_VES"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)")] = String(row[inputHeaderMap["Offer_Account_Currency"]] || '');

                                ofertaNoPactadaRawData.push(newRow);
                            }
                        });
                    }
                }

                if (!hasOfertaData) {
                    const emptyRow = new Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill(null);
                    emptyRow[0] = "0"; // Solo el valor, el estilo se aplicará después
                    ofertaNoPactadaRawData.push(emptyRow);
                }

                const wsOferta = XLSX.utils.aoa_to_sheet(ofertaNoPactadaRawData);

                // Aplicar estilos a la hoja de Oferta
                const ofertaRange = XLSX.utils.decode_range(wsOferta['!ref']);

                // Estilo para la Fila 1 (Título)
                const styleOfertaTitle = {
                    font: { sz: 10, bold: true, color: { rgb: "FFFFFFFF" } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    fill: { fgColor: { rgb: "FF366092" } },
                    border: borderThin
                };
                const cellRefTitleOferta = XLSX.utils.encode_cell({ r: 0, c: 0 });
                if (wsOferta[cellRefTitleOferta]) {
                    wsOferta[cellRefTitleOferta].s = styleOfertaTitle;
                } else {
                    wsOferta[cellRefTitleOferta] = { v: "Oferta (No Pactada)", t: 's', s: styleOfertaTitle };
                }

                // Estilo para la Fila 2 (Encabezados)
                const styleOfertaHeader = {
                    font: { sz: 10 },
                    alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                    fill: { fgColor: { rgb: "FFD9D9D9" } },
                    border: borderThin
                };
                for (let C = 0; C < NO_PACTADAS_OUTPUT_HEADERS.length; ++C) {
                    const cellRef = XLSX.utils.encode_cell({ r: 1, c: C });
                    if (!wsOferta[cellRef]) wsOferta[cellRef] = { v: NO_PACTADAS_OUTPUT_HEADERS[C], t: 's' };
                    wsOferta[cellRef].s = styleOfertaHeader;
                }

                // Estilos para las filas de datos (a partir de la fila 3)
                const ofertaDataTextStyle = { font: { sz: 11 }, alignment: { vertical: "center", horizontal: "left" }, border: borderThin };
                const ofertaDataNumberStyle = { font: { sz: 11 }, alignment: { vertical: "center", horizontal: "right" }, border: borderThin };

                for (let R = 2; R <= ofertaRange.e.r; ++R) { // Empieza desde la fila 2 (índice 2)
                    for (let C = 0; C <= ofertaRange.e.c; ++C) {
                        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!wsOferta[cellRef]) wsOferta[cellRef] = {};

                        let currentCell = wsOferta[cellRef];

                        // Ajustar el tipo de celda y el formato numérico si es necesario
                        if (C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa") ||
                            C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD") ||
                            C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")) {
                            currentCell.t = 'n';
                            currentCell.z = '#,##0.00';
                            currentCell.s = { ...ofertaDataNumberStyle, numFmt: currentCell.z };
                            if (typeof currentCell.v !== 'number' && typeof currentCell.v !== 'string') {
                                currentCell.v = ''; // Asegurar que sea vacío si no es un número/string
                            } else if (typeof currentCell.v === 'string') {
                                const parsed = parseVenezuelanNumber(currentCell.v);
                                currentCell.v = parsed !== null ? parsed : '';
                            }
                        } else if (C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")) {
                            currentCell.t = 'n';
                            currentCell.z = '#,##0.0000';
                            currentCell.s = { ...ofertaDataNumberStyle, numFmt: currentCell.z };
                            if (typeof currentCell.v !== 'number' && typeof currentCell.v !== 'string') {
                                currentCell.v = '';
                            } else if (typeof currentCell.v === 'string') {
                                const parsed = parseVenezuelanNumber(currentCell.v);
                                currentCell.v = parsed !== null ? parsed : '';
                            }
                        } else {
                            currentCell.t = 's';
                            currentCell.z = '@';
                            currentCell.s = { ...ofertaDataTextStyle, numFmt: currentCell.z };
                            if (currentCell.v === null || currentCell.v === undefined) {
                                currentCell.v = '';
                            }
                        }

                        // Si la fila es la del "0" y no hay datos, aplicar estilo centrado al "0"
                        if (!hasOfertaData && R === 2 && C === 0) {
                            currentCell.s.alignment.horizontal = 'center';
                        }
                    }
                }

                // Combinar celdas para el título
                wsOferta['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: NO_PACTADAS_OUTPUT_HEADERS.length - 1 } }];

                // Establecer anchos de columna
                wsOferta['!cols'] = Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill({ wch: 15 });
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Jornada")] = { wch: 15 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Registro")] = { wch: 15 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Hora Registro")] = { wch: 12 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa")] = { wch: 15 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD")] = { wch: 15 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")] = { wch: 18 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")] = { wch: 18 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Nombre Operador")] = { wch: 30 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("RIF/CI")] = { wch: 20 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cliente")] = { wch: 30 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Nacional")] = { wch: 25 };
                wsOferta['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)")] = { wch: 30 };

                wsOferta['!sheet'] = {
                    'SheetPr': {
                        'TabColor': { 'rgb': "FFFFD700" } // Amarillo dorado para Oferta
                    }
                };
                XLSX.utils.book_append_sheet(wb, wsOferta, "Oferta (No pactada)");


                // ----------------------------------------------------
                // HOJA: Demanda (No pactada)
                // ----------------------------------------------------
                const demandaNoPactadaRawData = [];
                let hasDemandaData = false;

                // Añadir títulos y encabezados como arrays simples para aoa_to_sheet
                const demandaTitleRow_simple = [];
                demandaTitleRow_simple[0] = "Demanda (No Pactada)";
                demandaNoPactadaRawData.push(demandaTitleRow_simple);
                demandaNoPactadaRawData.push(NO_PACTADAS_OUTPUT_HEADERS); // Solo los nombres de los encabezados

                // Procesar datos de ofertaWorkbookData si está cargado
                if (ofertaWorkbookData) {
                    const firstSheetNameNoPactadas = ofertaWorkbookData.SheetNames[0];
                    const worksheetNoPactadas = ofertaWorkbookData.Sheets[firstSheetNameNoPactadas];

                    if (worksheetNoPactadas && worksheetNoPactadas['!ref']) {
                        const rawNoPactadasData = XLSX.utils.sheet_to_json(worksheetNoPactadas, {
                            header: 1, // Obtener como array de arrays
                            range: 1,  // Empezar a leer desde la fila 2 (índice 1 en 0-based)
                            defval: "",
                            raw: false,
                            dateNF: 'yyyy-mm-dd HH:mm:ss'
                        });

                        const inputHeadersNoPactadas = XLSX.utils.sheet_to_json(worksheetNoPactadas, { header: 1, range: 0, defval: "", raw: false })[0];
                        const inputHeaderMap = {};
                        inputHeadersNoPactadas.forEach((header, index) => {
                            inputHeaderMap[header] = index;
                        });

                        const today = new Date();
                        const todayFormatted = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

                        rawNoPactadasData.forEach(row => {
                            const operationType = String(row[inputHeaderMap["OperationType"]] || '').trim();

                            if (operationType === "DEMANDA") {
                                hasDemandaData = true;
                                const newRow = new Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill(null);

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Jornada")] = todayFormatted;
                                const pactDate = String(row[inputHeaderMap["PactDate"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Registro")] = pactDate.substring(0, 10);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Hora Registro")] = pactDate.substring(11, 19);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Código Moneda Divisa")] = String(row[inputHeaderMap["CurrencyCode"]] || '');

                                let montoDivisa = parseVenezuelanNumber(row[inputHeaderMap["CurrencyAmount"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa")] = montoDivisa !== null ? montoDivisa : '';

                                let montoUSD = parseVenezuelanNumber(row[inputHeaderMap["CurrencyBaseAmount"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD")] = montoUSD !== null ? montoUSD : '';

                                let tipoCambio = parseVenezuelanNumber(row[inputHeaderMap["PriceVES_Currency"]]);
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")] = tipoCambio !== null ? tipoCambio : '';

                                let contravalorBs = null;
                                if (montoUSD !== null && tipoCambio !== null) {
                                    contravalorBs = parseFloat((montoUSD * tipoCambio).toFixed(2));
                                }
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")] = contravalorBs !== null ? contravalorBs : '';

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Instrumento")] = String(row[inputHeaderMap["InstrumentType"]] || '');

                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Código Operador")] = String(row[inputHeaderMap["Demand_OperatorCode"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Nombre Operador")] = String(row[inputHeaderMap["Demand_OperatorName"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("RIF/CI")] = String(row[inputHeaderMap["Demand_CustomerIdentification"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cliente")] = String(row[inputHeaderMap["Demand_ClientName"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Nacional")] = String(row[inputHeaderMap["Demand_Account_VES"]] || '');
                                newRow[NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)")] = String(row[inputHeaderMap["Demand_Account_Currency"]] || '');

                                demandaNoPactadaRawData.push(newRow);
                            }
                        });
                    }
                }

                if (!hasDemandaData) {
                    const emptyRow = new Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill(null);
                    emptyRow[0] = "0"; // Solo el valor, el estilo se aplicará después
                    demandaNoPactadaRawData.push(emptyRow);
                }

                const wsDemanda = XLSX.utils.aoa_to_sheet(demandaNoPactadaRawData);

                // Aplicar estilos a la hoja de Demanda
                const demandaRange = XLSX.utils.decode_range(wsDemanda['!ref']);

                // Estilo para la Fila 1 (Título)
                const styleDemandaTitle = {
                    font: { sz: 10, bold: true, color: { rgb: "FFFFFFFF" } },
                    alignment: { horizontal: 'center', vertical: 'center' },
                    fill: { fgColor: { rgb: "FF538DD5" } },
                    border: borderThin
                };
                const cellRefTitleDemanda = XLSX.utils.encode_cell({ r: 0, c: 0 });
                if (wsDemanda[cellRefTitleDemanda]) {
                    wsDemanda[cellRefTitleDemanda].s = styleDemandaTitle;
                } else {
                    wsDemanda[cellRefTitleDemanda] = { v: "Demanda (No Pactada)", t: 's', s: styleDemandaTitle };
                }

                // Estilo para la Fila 2 (Encabezados)
                const styleDemandaHeader = {
                    font: { sz: 10 },
                    alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
                    fill: { fgColor: { rgb: "FFD9D9D9" } },
                    border: borderThin
                };
                for (let C = 0; C < NO_PACTADAS_OUTPUT_HEADERS.length; ++C) {
                    const cellRef = XLSX.utils.encode_cell({ r: 1, c: C });
                    if (!wsDemanda[cellRef]) wsDemanda[cellRef] = { v: NO_PACTADAS_OUTPUT_HEADERS[C], t: 's' };
                    wsDemanda[cellRef].s = styleDemandaHeader;
                }

                // Estilos para las filas de datos (a partir de la fila 3)
                const demandaDataTextStyle = { font: { sz: 11 }, alignment: { vertical: "center", horizontal: "left" }, border: borderThin };
                const demandaDataNumberStyle = { font: { sz: 11 }, alignment: { vertical: "center", horizontal: "right" }, border: borderThin };

                for (let R = 2; R <= demandaRange.e.r; ++R) { // Empieza desde la fila 2 (índice 2)
                    for (let C = 0; C <= demandaRange.e.c; ++C) {
                        const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!wsDemanda[cellRef]) wsDemanda[cellRef] = {};

                        let currentCell = wsDemanda[cellRef];

                        // Ajustar el tipo de celda y el formato numérico si es necesario
                        if (C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa") ||
                            C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD") ||
                            C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")) {
                            currentCell.t = 'n';
                            currentCell.z = '#,##0.00';
                            currentCell.s = { ...demandaDataNumberStyle, numFmt: currentCell.z };
                            if (typeof currentCell.v !== 'number' && typeof currentCell.v !== 'string') {
                                currentCell.v = '';
                            } else if (typeof currentCell.v === 'string') {
                                const parsed = parseVenezuelanNumber(currentCell.v);
                                currentCell.v = parsed !== null ? parsed : '';
                            }
                        } else if (C === NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")) {
                            currentCell.t = 'n';
                            currentCell.z = '#,##0.0000';
                            currentCell.s = { ...demandaDataNumberStyle, numFmt: currentCell.z };
                            if (typeof currentCell.v !== 'number' && typeof currentCell.v !== 'string') {
                                currentCell.v = '';
                            } else if (typeof currentCell.v === 'string') {
                                const parsed = parseVenezuelanNumber(currentCell.v);
                                currentCell.v = parsed !== null ? parsed : '';
                            }
                        } else {
                            currentCell.t = 's';
                            currentCell.z = '@';
                            currentCell.s = { ...demandaDataTextStyle, numFmt: currentCell.z };
                            if (currentCell.v === null || currentCell.v === undefined) {
                                currentCell.v = '';
                            }
                        }

                        // Si la fila es la del "0" y no hay datos, aplicar estilo centrado al "0"
                        if (!hasDemandaData && R === 2 && C === 0) {
                            currentCell.s.alignment.horizontal = 'center';
                        }
                    }
                }

                // Combinar celdas para el título
                wsDemanda['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: NO_PACTADAS_OUTPUT_HEADERS.length - 1 } }];

                // Establecer anchos de columna
                wsDemanda['!cols'] = Array(NO_PACTADAS_OUTPUT_HEADERS.length).fill({ wch: 15 });
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Jornada")] = { wch: 15 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Fecha Registro")] = { wch: 15 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Hora Registro")] = { wch: 12 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto Divisa")] = { wch: 15 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Monto USD")] = { wch: 15 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Tipo de Cambio Bs./USD")] = { wch: 18 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Contravalor Bs.")] = { wch: 18 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Nombre Operador")] = { wch: 30 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("RIF/CI")] = { wch: 20 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cliente")] = { wch: 30 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Nacional")] = { wch: 25 };
                wsDemanda['!cols'][NO_PACTADAS_OUTPUT_HEADERS.indexOf("Cuenta Moneda Extranjera (Opcional)")] = { wch: 30 };

                wsDemanda['!sheet'] = {
                    'SheetPr': {
                        'TabColor': { 'rgb': "FFADD8E6" } // Azul claro para Demanda
                    }
                };
                XLSX.utils.book_append_sheet(wb, wsDemanda, "Demanda (No pactada)");

                XLSX.writeFile(wb, fileName);
            });
        });
    </script>
</body>

</html>